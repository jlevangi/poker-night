# Poker Night AI Coding Agent Instructions

## Project Architecture
This is a full-stack poker session management web app with PWA capabilities.

- **Backend**: Flask app using factory pattern (`backend/app/__init__.py`). Routes organized by domain in `backend/app/routes/` with blueprints. SQLAlchemy ORM with auto-migrations.
- **Frontend**: Single-page app with ES6 modules. Router-based navigation (`frontend/static/js/modules/router.js`). API communication via `api-service.js`. No build tools - pure JS/CSS.
- **Database**: SQLite with 4 core models: `Player`, `Session`, `Entry` (join table), `PushSubscription`. Auto-backup and migrations via admin endpoints.
- **Service**: Systemd service auto-generated by `install.sh`. Runs as daemon with automatic restart.

## Critical Patterns
- **Path Calculation**: All paths computed dynamically in `Config.__init__()` relative to backend directory. Use `--debug-paths` to troubleshoot static/template loading.
- **Money Handling**: All monetary values use `round_to_cents()` helper to prevent floating point errors. Import from `models.py`.
- **ID Generation**: Uses predictable patterns: `pid_001` (players), `sid_YYYYMMDD_N` (sessions), `eid_NNNN` (entries).
- **Admin Auth**: Session-based auth using password hash. No JWT. Check `session['admin_authenticated']` with `@require_admin_auth` decorator.
- **API Design**: RESTful with consistent JSON responses. All API routes under `/api/*` prefix except admin (`/admin/*`).

## Development Workflows
- **Local Development**: `python backend/run.py --debug --config development --port 5000 --debug-paths`
- **Production Deployment**: `sudo ./install.sh` handles everything - dependencies, venv, systemd service, file copying
- **Service Management**: `systemctl {start|stop|restart|status} poker-night.service`
- **Database Operations**: Use admin endpoints `/admin/backup`, `/admin/restore`, `/admin/migrate` (require auth)

## Environment Configuration
Auto-generated `.env` in project root contains:
- `ADMIN_PASSWORD_HASH`: Scrypt hash for admin login (default: `admin123`)
- `APP_VERSION`: Used for cache busting in templates via `versioned_url()`
- `VAPID_*`: Push notification keys (auto-generated if missing)

Generate new admin hash: `./venv/bin/python scripts/generate_password_hash.py "newpassword"`

## Key Integration Points
- **Frontend State**: No global state management. Each page module (`*-page.js`) handles its own state and API calls.
- **Push Notifications**: Uses Web Push API with VAPID authentication. Service handles subscription management and message delivery.
- **Auto-Migrations**: `AutoMigration.run_auto_migrations()` runs on app startup. Add new migrations to `backend/app/database/migrations.py`.
- **Static Assets**: Versioned URLs via `versioned_url()` template function prevents cache issues during updates.

## Common Tasks
```bash
# Debug path issues
python backend/run.py --debug-paths

# Check service logs
journalctl -u poker-night.service -f

# Manual backup
curl -X POST http://localhost:5000/admin/backup -H "Content-Type: application/json" -d '{"password":"admin123"}'

# Update and restart
sudo ./install.sh && systemctl status poker-night.service
```

## File Structure Essentials
- `backend/app/config.py`: Path calculation logic and environment loading
- `backend/app/database/models.py`: Core data models with validation helpers
- `frontend/static/js/app.js`: Application bootstrap and service worker setup
- `frontend/static/js/modules/`: Modular frontend architecture
- `install.sh`: Complete deployment automation (production vs development mode detection)

---
_Focus on the "why" behind architectural decisions. This app prioritizes simplicity over complexity - no build tools, minimal dependencies, SQLite over PostgreSQL, session auth over JWT._
